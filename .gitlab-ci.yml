image: ruby:2.7

variables:
  JEKYLL_ENV: production
  LC_ALL: C.UTF-8

before_script:
  - bundle install

test:
  stage: test
  script:
  - bundle exec jekyll build -d test
  artifacts:
    paths:
    - test
  except:
  - main
  - schedule

pages:
  stage: deploy
  script:
  - bundle exec jekyll build -d public
  artifacts:
    paths:
    - public
  only:
  - main
  except:
  - schedule

daily-pipeline:
  image: python:3.8
  stage: deploy
  variables:
    JOB_ID: ATHENA-PROD
    TARGET_ATHENA_S3_BUCKET: prod-meltano-bucket-01
    DBT_TARGET: athena
    STAGE: prod
  before_script:
  - ''
  script:
  - cd meltano/
  - pip3 install meltano
  - meltano install
  - echo "Installing creds file from CI..." && cp $MELTANO_ENV_FILE .env
  - meltano elt tap-github target-athena --job_id=$JOB_ID
  - apt-get update && apt-get install jq
  - |
    echo "Logging current state...\n" && \
    meltano elt tap-github target-athena --job_id=$JOB_ID --dump=state |  jq '.'     
  only:
  - schedule
