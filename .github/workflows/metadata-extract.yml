name: Metadata Extract

on:
  workflow_dispatch:

jobs:
  sdk_variants:
    runs-on: ubuntu-latest
    outputs:
       matrix: ${{ steps.setmatrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3.3.0

      - name: Install hub_utils
        run: pipx install git+https://github.com/pnadolny13/hub-utils.git@github_action_commands

      - name: testing
        run: hub_utils get-variant-names $(pwd)

      - name: testing 2
        run: ls

      - name: Get Variants List
        id: get-variants-list
        run: echo $(pwd) && echo "VARIANTS=$(hub_utils get-variant-names $(pwd))" >> $GITHUB_OUTPUT

      - name: Set Dynamic Matrix
        id: setmatrix
        run: |
           matrixStringifiedObject="{\"include\": ${{ steps.get-variants-list.outputs.VARIANTS }}}"
           echo "::set-output name=matrix::$matrixStringifiedObject"

  metadata_extract_sdk:
    name: Metadata Extract SDK
    needs: sdk_variants
    runs-on: ubuntu-latest
    env:
      AWS_S3_BUCKET: "${{secrets.AWS_S3_BUCKET }}"
      AWS_ACCESS_KEY_ID: "${{secrets.AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{secrets.AWS_SECRET_ACCESS_KEY }}"
      AWS_SESSION_TOKEN: "${{secrets.AWS_SESSION_TOKEN }}"
    strategy:
      matrix: ${{ fromJson(needs.sdk_variants.outputs.matrix) }}
    steps:
    - uses: actions/checkout@v3.3.0

    - name: Install hub_utils
      run: pipx install git+https://github.com/pnadolny13/hub-utils.git@github_action_commands

    - name: Extract Metadata
      run: hub_utils extract-metadata-v2 "/home/runner/work/hub/hub/_data/meltano/${{ matrix.source-name }}" $(pwd)/extract_data
