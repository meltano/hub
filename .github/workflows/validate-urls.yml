name: Validate URLs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * 1'

jobs:

  validate_urls:
    name: Validate URLs
    runs-on: ubuntu-latest
    environment: 'production'
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: 3.9
          architecture: x64

      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0

      - name: Install lychee
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2.7.0
        with:
          args: --version

      - name: Extract URLs from YAML files
        run: |
          uv run python utility_scripts/plugin_definitions/extract_urls.py > urls.txt
          echo "Extracted $(wc -l < urls.txt) unique URLs to check"

      - name: Check URLs with lychee
        id: lychee
        continue-on-error: true
        run: |
          lychee --config .github/workflows/resources/lychee.toml \
                 --format json \
                 --output lychee-output.json \
                 urls.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Format lychee output
        id: urls
        if: always()
        run: |
          if [ -f lychee-output.json ]; then
            output=$(cat lychee-output.json | uv run python utility_scripts/plugin_definitions/format_lychee_output.py)
            echo "INVALID_URL<<EOF" >> $GITHUB_ENV
            echo "$output" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "INVALID_URL=" >> $GITHUB_ENV
          fi
      - uses: JasonEtco/create-an-issue@1b14a70e4d8dc185e5cc76d3bec9eab20257b2c5 # v2.9.2
        if: env.INVALID_URL != ''
        env:
          GITHUB_TOKEN: ${{ secrets.MELTYBOT_GITHUB_AUTH_TOKEN }}
          INVALID_URLS: ${{ env.INVALID_URL }}
        with:
          filename: .github/ISSUE_TEMPLATE/invalid_urls.md
          update_existing: true
