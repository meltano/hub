name: Metadata Refresh

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'The environment to run the workflow in'
        required: true
        type: choice
        default: 'preview'
        options:
          - 'preview'
          - 'production'
  # schedule:
  #   - cron: '0 0 * * *' # Run at midnight UTC

jobs:

  metadata_refresh:
    name: Metadata Refresh
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment == 'production' || github.event_name == 'schedule' && 'production' || 'preview' }}
    env:
      AWS_S3_BUCKET: "${{secrets.HUB_METADATA_S3_BUCKET }}"
    permissions:
      id-token: write # This is required for requesting the JWT
    steps:
    - uses: actions/checkout@v3.3.0
      # TODO: will need this to trigger CI jobs
      # with:
      #   token: ${{ secrets.GH_PAT }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2.0.0
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: us-west-2
        role-session-name: "GitHubActions"

    - name: Install hub_utils
      run: pipx install git+https://github.com/pnadolny13/hub-utils.git@main

    - name: Download Raw JSON Output
      run: hub_utils download-metadata "/home/runner/work/downloaded_data"

    - name: Merge Raw JSON and Existing Definition
      run: hub_utils merge-metadata $(pwd) "/home/runner/work/downloaded_data"

    - name: Commit changes
      uses: EndBug/add-and-commit@v9
      with:
        add: '_data/meltano/*.yml'
        message: 'Hub bot update'
        new_branch: hub-bot-metadata-${{ github.run_id }}-${{ github.run_number }}-${{ github.run_attempt }}
